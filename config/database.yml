# PostgreSQL. Versions 9.3 and up are supported.
#
# Install the pg driver:
#   gem install pg
# On macOS with Homebrew:
#   gem install pg -- --with-pg-config=/usr/local/bin/pg_config
# On macOS with MacPorts:
#   gem install pg -- --with-pg-config=/opt/local/lib/postgresql84/bin/pg_config
# On Windows:
#   gem install pg
#       Choose the win32 build.
#       Install PostgreSQL and put its /bin directory on your path.
#
# Configure Using Gemfile
# gem "pg"
#
default: &default
  adapter: postgresql
  encoding: unicode
  # For details on connection pooling, see Rails configuration guide
  # https://guides.rubyonrails.org/configuring.html#database-pooling
  pool: <%= ENV.fetch("RAILS_MAX_THREADS") { 5 } %>

development:
  <<: *default
  # Use DATABASE_URL from .env (Supabase)
  <% if ENV["DATABASE_URL"] %>
  url: <%= ENV["DATABASE_URL"] %>
  <% else %>
  # Fallback for development without DATABASE_URL
  database: prostaff_api_development
  host: localhost
  port: 5432
  username: postgres
  password: password
  <% end %>

  # The specified database role being used to connect to postgres.
  # To create additional roles in postgres see `$ createuser --help`.
  # When left blank, postgres will use the default role. This is
  # the same name as the operating system user running Rails.
  #username: prostaff_api

  # The password associated with the postgres role (username).
  #password:

  # Connect on a TCP socket. Omitted by default since the client uses a
  # domain socket that doesn't need configuration. Windows does not have
  # domain sockets, so uncomment these lines.
  #host: localhost

  # The TCP port the server listens on. Defaults to 5432.
  # If your server runs on a different port number, change accordingly.
  #port: 5432

  # Schema search path. The server defaults to $user,public
  #schema_search_path: myapp,sharedapp,public

  # Minimum log levels, in increasing order:
  #   debug5, debug4, debug3, debug2, debug1,
  #   log, notice, warning, error, fatal, and panic
  # Defaults to warning.
  #min_messages: notice

# Warning: The database defined as "test" will be erased and
# re-generated from your development database when you run "rake".
# Do not set this db to the same as development or production.
test:
  <<: *default
  # SAFETY: NEVER use DATABASE_URL in test - ALWAYS localhost only
  # This is hardcoded to prevent accidental production database access
  database: prostaff_api_test
  host: localhost
  port: 5432
  username: postgres
  password: password
  # Explicitly ignore DATABASE_URL for test environment
  url: postgresql://postgres:password@localhost:5432/prostaff_api_test

# As with config/credentials.yml, you never want to store sensitive information,
# like your database password, in your source code. If your source code is
# ever seen by anyone, they now have access to your database.
#
# Instead, provide the password or a full connection URL as an environment
# variable when you boot the app. For example:
#
#   DATABASE_URL="postgres://myuser:mypass@localhost/somedatabase"
#
# If provided, a database URL will override the database, username, and password
# settings above.
#
# For more information on using database URLs, see the Rails configuration guide:
# https://guides.rubyonrails.org/configuring.html#configuring-a-database
#
production:
  <<: *default
  <%
    # Use SUPABASE_DB_URL to avoid Rails auto-parsing DATABASE_URL with special chars
    db_url = ENV['SUPABASE_DB_URL'] || ENV['DATABASE_URL']
    if db_url
      begin
        # Parse database URL manually to handle special characters in password
        # Format: scheme://username:password@host:port/database
        # Use regex to extract from right to left to handle @ in password
        if db_url =~ /^([^:]+):\/\/(.+)@([^@\/]+):(\d+)\/(.+)$/
          scheme = $1
          user_pass = $2  # username:password
          host = $3
          port = $4
          database = $5

          # Split user_pass on first colon only
          if user_pass =~ /^([^:]+):(.+)$/
            username = $1
            password = $2
  %>
  adapter: <%= scheme %>
  username: <%= username %>
  password: <%= password %>
  host: <%= host %>
  port: <%= port %>
  database: <%= database %>
  <%
          end
        end
      rescue => e
        # Fallback to direct URL if parsing fails (only safe if URL is properly encoded)
  %>
  url: <%= db_url %>
  <%
      end
    else
      # Fallback for when DATABASE_URL is not available (e.g., during Docker build)
      # This allows the app to build without a database connection
  %>
  database: prostaff_api_production
  adapter: postgresql
  <%
    end
  %>