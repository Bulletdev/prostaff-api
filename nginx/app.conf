upstream puma_rails_app {
  server api:3000;
  keepalive 16;
}

# Cache key configuration
map $request_uri $cache_key {
    default $scheme$host$request_uri;
}

# Determine if request should be cached
map $request_method $skip_cache {
    default 1;
    GET 0;
    HEAD 0;
}

server {
  listen 80;
  server_name _;

  # Buffer settings
  proxy_buffers 64 16k;
  proxy_buffer_size 16k;
  proxy_max_temp_file_size 1024m;

  # Timeout settings
  proxy_connect_timeout 30s;
  proxy_send_timeout 60s;
  proxy_read_timeout 60s;

  # Logs
  access_log /var/log/nginx/app.access.log detailed;
  error_log /var/log/nginx/app.error.log warn;

  # Health check endpoint (no rate limiting)
  location /health {
    proxy_pass http://puma_rails_app;
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    access_log off;
  }

  # Admin endpoints - strict rate limiting
  location ~ ^/api/admin {
    limit_req zone=admin_api burst=20 nodelay;
    limit_req zone=riot_api_long burst=10;

    proxy_pass http://puma_rails_app;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_redirect off;

    # No caching for admin endpoints
    proxy_no_cache 1;
    proxy_cache_bypass 1;
  }

  # Riot API proxy endpoints - strict rate limiting to comply with Riot limits
  location ~ ^/api/(riot|matches|summoners|champions|masteries) {
    # Apply both rate limits:
    # - Short burst: 20r/s (we use 18r/s for safety margin)
    # - Long term: 100r/2min (we use 45r/min for safety)
    limit_req zone=riot_api_short burst=15 nodelay;
    limit_req zone=riot_api_long burst=30;

    # Cache configuration for Riot API responses
    proxy_cache riot_cache;
    proxy_cache_key $cache_key;
    proxy_cache_valid 200 302 5m;    # Cache successful responses for 5 minutes
    proxy_cache_valid 404 1m;         # Cache not found for 1 minute
    proxy_cache_valid any 30s;        # Cache other responses for 30 seconds
    proxy_cache_bypass $skip_cache;
    proxy_no_cache $skip_cache;

    # Add cache status to response headers
    add_header X-Cache-Status $upstream_cache_status always;
    add_header X-Rate-Limit "Riot API: 18r/s, 45r/m" always;

    proxy_pass http://puma_rails_app;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_redirect off;

    # Enable cache revalidation
    proxy_cache_revalidate on;
    proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
    proxy_cache_background_update on;
    proxy_cache_lock on;
  }

  # Analytics endpoints - moderate rate limiting
  location ~ ^/api/analytics {
    limit_req zone=general_api burst=50 nodelay;

    # Cache analytics for 2 minutes
    proxy_cache riot_cache;
    proxy_cache_key $cache_key;
    proxy_cache_valid 200 2m;
    proxy_cache_bypass $skip_cache;
    proxy_no_cache $skip_cache;
    add_header X-Cache-Status $upstream_cache_status always;

    proxy_pass http://puma_rails_app;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_redirect off;
  }

  # Authentication endpoints - moderate rate limiting
  location ~ ^/api/(auth|login|logout|signup) {
    limit_req zone=general_api burst=30 nodelay;

    proxy_pass http://puma_rails_app;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_redirect off;

    # No caching for auth endpoints
    proxy_no_cache 1;
    proxy_cache_bypass 1;
  }

  # General API endpoints
  location /api/ {
    limit_req zone=general_api burst=100 nodelay;

    proxy_pass http://puma_rails_app;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_redirect off;
  }

  # Static files and assets
  location ~ ^/(assets|packs)/ {
    gzip_static on;
    expires max;
    add_header Cache-Control public;
    access_log off;

    proxy_pass http://puma_rails_app;
    proxy_set_header Host $http_host;
  }

  # Default location
  location / {
    limit_req zone=general_api burst=50 nodelay;

    proxy_pass http://puma_rails_app;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_redirect off;
  }

  # Custom error pages
  error_page 429 @rate_limit_error;
  location @rate_limit_error {
    default_type application/json;
    return 429 '{"error": "Rate limit exceeded. Please try again later.", "code": 429}';
  }

  error_page 502 503 504 @backend_error;
  location @backend_error {
    default_type application/json;
    return 503 '{"error": "Service temporarily unavailable", "code": 503}';
  }
}
